const osmosis = require('osmosis');
const fs = require('fs');

const baseUrl = 'https://www.skypeenglishclasses.com/english-phrasal-verbs/';
const list = [
  "aim-at",
  "ask-for",
  "ask-out",
  "back-down",
  "back-off",
  "back-up",
  "beat-up",
  "beef-up",
  "believe-in",
  "bite-off",
  "blow-away",
  "blow-off",
  "blow-up",
  "boil-down-to",
  "break-down",
  "break-in",
  "break-off",
  "break-out",
  "break-through",
  "break-up",
  "bring-back",
  "bring-over",
  "bring-up",
  "brush-off",
  "brush-up",
  "build-ininto",
  "bump-into",
  "burn-down",
  "burn-out",
  "burn-up",
  "burst-out",
  "butt-in",
  "call-back",
  "call-in",
  "call-off",
  "call-up",
  "calm-down",
  "care-for",
  "carry-away",
  "carry-on",
  "carry-out",
  "catch-on",
  "catch-up",
  "cheat-on",
  "check-in",
  "check-out",
  "chicken-out",
  "chop-up",
  "clean-out",
  "clear-out",
  "clear-up",
  "clog-up",
  "close-down",
  "close-off",
  "come-about",
  "come-across",
  "come-apart",
  "come-back",
  "come-down",
  "come-down-to",
  "come-down-with",
  "come-in",
  "come-off",
  "come-on",
  "come-out",
  "come-over",
  "come-through",
  "come-up",
  "come-up-with",
  "con-into",
  "con-out-of",
  "cool-off",
  "count-on",
  "count-up",
  "cover-up",
  "crack-down",
  "cross-off",
  "cut-back",
  "cut-down",
  "cut-off",
  "cut-out",
  "cut-up",
  "deal-with",
  "do-away-with",
  "do-over",
  "do-with",
  "do-without",
  "doze-off",
  "dress-up",
  "drop-in",
  "drop-off",
  "drop-out",
  "dry-off",
  "dry-out",
  "dry-up",
  "eat-up",
  "empty-out",
  "end-up",
  "fall-apart",
  "fall-behind",
  "fall-down",
  "fall-for",
  "fall-off",
  "fall-off",
  "fall-over",
  "fall-through",
  "feel-up-to",
  "fight-back",
  "figure-on",
  "fill-in",
  "fill-out",
  "fill-up",
  "find-out",
  "fix-up",
  "flip-out",
  "float-around",
  "follow-up",
  "fool-around",
  "freak-out",
  "get-ahead",
  "get-along",
  "get-around-to",
  "get-away",
  "get-back",
  "get-back-at",
  "get-back-to",
  "get-behind",
  "get-by",
  "get-down",
  "get-in",
  "get-off",
  "get-off-on",
  "get-on",
  "get-out",
  "get-out-of",
  "get-over",
  "get-over-with",
  "get-through",
  "get-to",
  "get-together",
  "get-up",
  "give-away",
  "give-in",
  "give-out",
  "give-up",
  "go-about",
  "go-after",
  "go-ahead",
  "go-along-with",
  "go-around",
  "go-away",
  "go-back",
  "go-back-on",
  "go-beyond",
  "go-by",
  "go-down",
  "go-for",
  "go-in",
  "go-in-for",
  "go-in-into",
  "go-off",
  "go-on",
  "go-out",
  "go-over",
  "go-through-with",
  "go-up",
  "go-with",
  "goof-around",
  "gross-out",
  "grow-out-of",
  "grow-up",
  "hand-back",
  "hand-in",
  "hand-out",
  "hand-over",
  "hang-around",
  "hang-on",
  "hang-out",
  "hang-up",
  "have-on",
  "head-back",
  "head-for",
  "head-toward",
  "hear-about",
  "hear-of",
  "heat-up",
  "help-out",
  "hit-on",
  "hold-against",
  "hold-off",
  "hold-on",
  "hold-out",
  "hold-up",
  "hook-up",
  "hurry-up",
  "keep-at",
  "keep-away",
  "keep-down",
  "keep-from",
  "keep-off",
  "keep-on",
  "keep-to",
  "keep-up",
  "kick-back",
  "kick-out",
  "knock-off",
  "knock-out",
  "knock-over",
  "know-about",
  "lay-down",
  "lay-off",
  "lead-up-to",
  "leave-behind",
  "leave-off",
  "leave-out",
  "leave-over",
  "let-down",
  "let-in",
  "let-off",
  "let-on",
  "let-out",
  "let-up",
  "lie-around",
  "lift-up",
  "light-up",
  "lighten-up",
  "line-up",
  "live-with",
  "lock-in",
  "lock-out",
  "lock-up",
  "look-around",
  "look-at",
  "look-down-on",
  "look-forward-to",
  "look-into",
  "look-out",
  "look-over",
  "look-up",
  "look-up-to",
  "luck-out",
  "make-for",
  "make-of",
  "make-up",
  "mess-up",
  "mix-up",
  "monkey-around-with",
  "move-in",
  "move-out",
  "narrow-down",
  "pay-back",
  "pay-for",
  "pay-off",
  "pay-up",
  "pick-on",
  "pick-out",
  "pick-up",
  "pile-up",
  "piss-off",
  "plan-ahead",
  "plan-for",
  "plan-on",
  "plug-ininto",
  "plug-up",
  "point-out",
  "point-to",
  "print-out",
  "pull-off",
  "pull-out",
  "pull-over",
  "pull-through",
  "punch-in",
  "punch-out",
  "put-away",
  "put-back",
  "put-down",
  "put-in",
  "put-off",
  "put-out",
  "put-past",
  "put-to",
  "put-together",
  "put-up",
  "put-up-to",
  "put-up-with",
  "ring-up",
  "rip-off",
  "rip-up",
  "rule-out",
  "run-across",
  "run-around",
  "run-down",
  "run-into",
  "run-out",
  "run-over",
  "run-up",
  "screw-on",
  "screw-out-of",
  "screw-up",
  "see-about",
  "sell-out",
  "set-up",
  "settle-down",
  "settle-for",
  "shake-up",
  "show-off",
  "shut-off",
  "shut-up",
  "sign-in",
  "sign-out",
  "sit-down",
  "slow-down",
  "sneak-ininto",
  "sneak-out",
  "sort-out",
  "space-out",
  "stand-around",
  "stand-for",
  "stand-up",
  "start-off",
  "start-out",
  "start-up",
  "stay-off",
  "stay-out",
  "stay-up",
  "step-on",
  "stick-around",
  "stick-out",
  "stick-to",
  "stick-up",
  "stick-with",
  "stop-off",
  "stop-over",
  "straighten-out",
  "stress-out",
  "switch-off",
  "switch-on",
  "take-apart",
  "take-back",
  "take-in",
  "take-out",
  "take-out-on",
  "take-up-on",
  "talk-down-to",
  "talk-into",
  "talk-out-of",
  "talk-to",
  "tear-down",
  "tear-off",
  "tell-apart",
  "tell-on",
  "think-about",
  "think-ahead",
  "think-up",
  "throw-away",
  "throw-out",
  "throw-up",
  "track-down",
  "trade-in",
  "trick-into",
  "try-on",
  "try-out",
  "turn-around",
  "turn-down",
  "turn-in",
  "turn-into",
  "turn-off",
  "turn-on",
  "turn-out",
  "turn-over",
  "turn-up",
  "use-up",
  "wake-up",
  "wash-off",
  "wash-up",
  "watch-out",
  "wear-down",
  "wear-off",
  "wear-out",
  "wear-out",
  "wipe-off",
  "wipe-out",
  "wipe-up",
  "work-in",
  "work-out",
  "work-up",
  "wrap-up",
  "zip-up"
];


async function getDesc(item) {
  return new Promise((resolve, reject) => {
        osmosis
          .get(`${baseUrl}/${item}/`)
          .set({
            desc: ['.profile-cols .text2 div:after-sibling(h3:starts-with("Definitions of")) p:not(:starts-with("See our complete"))']
          })
          .data((data) => {
            console.log('DATA:', data);

            let res = [];
            for (let i = 0; i < data.desc.length; i++) {
              if (i % 2 === 0) {
                const def = data.desc[i].match(/\d+\.\s(.*)$/);
                const desc = data.desc[i + 1].match(/(?:Examples\:\s)?(.*)$/);
                res.push({
                  word: item.replace(/-/g, ' '),
                  def: def && def[1].endsWith('.') ? def[1].substring(0, def[1].length) : def[1],
                  example: desc && desc[1] || data.desc[i + 1]
                });
              }
            }
            resolve(res);
          })
          .log(console.log)
          .error(console.log)
    }
  )
}

function delay(ms) {
  return new Promise(resolve => {
    setTimeout(() => resolve(), ms);
  });
}

async function batch(list, res = {}) {
  console.log(list.length);
  const items = list.splice(0, 3);
  await Promise.all(items.map(async (item) => {
    res[item] = await getDesc(item);
  }));

  fs.writeFileSync('./_data/phrasals-390.json', JSON.stringify(res, null, '  '));

  await delay(333);

  if (list.length) {
    await batch(list, res);
  }

  return res;
}

async function run() {
  const data = JSON.parse(fs.readFileSync('./_data/phrasals-390.json').toString())
  const desc = await batch(list.splice(list.length - 220), data);
  console.log('>', desc);
}
run();